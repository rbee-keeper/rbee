# TEAM-410: Daily marketplace update workflow
# Updates the marketplace with latest compatible models from HuggingFace

name: Update Marketplace

on:
  schedule:
    # Run daily at midnight UTC
    - cron: '0 0 * * *'
  workflow_dispatch:  # Allow manual trigger

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
      
      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
      
      - name: Install wasm-pack
        run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh
      
      - name: Install dependencies
        run: pnpm install
      
      - name: Build marketplace-sdk (WASM)
        run: |
          cd bin/79_marketplace_core/marketplace-sdk
          wasm-pack build --target nodejs --out-dir ../marketplace-node/wasm
      
      - name: Build marketplace-node
        run: |
          cd bin/79_marketplace_core/marketplace-node
          pnpm run build
      
      - name: Generate top 100 models list
        run: |
          npx tsx scripts/generate-top-100-models.ts
      
      - name: Build Next.js marketplace
        run: |
          cd frontend/apps/marketplace
          pnpm run build
        env:
          # Add any environment variables needed for build
          NODE_ENV: production
      
      - name: Deploy to Cloudflare Pages
        run: |
          cd frontend/apps/marketplace
          npx wrangler pages deploy out/ --project-name=rbee-marketplace
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
