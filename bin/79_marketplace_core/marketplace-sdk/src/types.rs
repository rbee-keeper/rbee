// TEAM-402: Marketplace types with tsify for TypeScript generation
// TEAM-402: Can now use artifacts-contract types if needed

use serde::{Deserialize, Serialize};
use tsify::Tsify;
use wasm_bindgen::prelude::*;

// TEAM-402: Re-export core artifact types (catalog types)
// TEAM-404: WorkerType and Platform are now canonical from artifacts-contract
// TEAM-407: Added ModelMetadata types for compatibility filtering
pub use artifacts_contract::{
    ModelEntry as CatalogModelEntry, 
    WorkerBinary as CatalogWorkerBinary,
    WorkerType,
};

/// Model file information
/// TEAM-421: Added for displaying model files in detail view
#[derive(Debug, Clone, Serialize, Deserialize)]
#[cfg_attr(target_arch = "wasm32", derive(tsify::Tsify))]
#[cfg_attr(all(not(target_arch = "wasm32"), feature = "specta"), derive(specta::Type))]
#[serde(rename_all = "camelCase")]
pub struct ModelFile {
    /// File name (relative path in repo)
    pub filename: String,
    /// File size in bytes (optional, using f64 for TypeScript compatibility)
    #[serde(skip_serializing_if = "Option::is_none")]
    pub size: Option<f64>,
}

/// Model from marketplace (HuggingFace or CivitAI)
/// 
/// TEAM-402: TypeScript types are AUTO-GENERATED by tsify.
/// TEAM-405: Added specta::Type for Tauri bindings (non-WASM)
/// TEAM-421: Added siblings field for model files
/// Import from SDK: `import type { Model } from '@rbee/marketplace-sdk'`
#[derive(Debug, Clone, Serialize, Deserialize)]
#[cfg_attr(target_arch = "wasm32", derive(tsify::Tsify))]
#[cfg_attr(all(not(target_arch = "wasm32"), feature = "specta"), derive(specta::Type))]
#[serde(rename_all = "camelCase")]
pub struct Model {
    /// Unique model identifier
    pub id: String,
    /// Model name
    pub name: String,
    /// Model description
    pub description: String,
    /// Model author (optional)
    #[serde(skip_serializing_if = "Option::is_none")]
    pub author: Option<String>,
    /// Model preview image URL (optional)
    #[serde(skip_serializing_if = "Option::is_none")]
    pub image_url: Option<String>,
    /// Model tags for categorization
    pub tags: Vec<String>,
    /// Total download count (using f64 for TypeScript compatibility)
    pub downloads: f64,
    /// Total likes/favorites (using f64 for TypeScript compatibility)
    pub likes: f64,
    /// Model size (human-readable, e.g., "4.2 GB")
    pub size: String,
    /// Provider - WHERE the model comes from (HuggingFace, Civitai, Local)
    pub provider: ModelProvider,
    /// Category - WHAT the model does (LLM, Image, Audio, etc.)
    pub category: ModelCategory,
    /// TEAM-421: Model files (from HuggingFace siblings)
    #[serde(skip_serializing_if = "Option::is_none")]
    pub siblings: Option<Vec<ModelFile>>,
}

// TEAM-460: Normalized provider system - all providers are equal

/// Model provider - WHERE the model comes from (all equal)
#[derive(Debug, Clone, Serialize, Deserialize, Tsify, PartialEq, Eq)]
#[cfg_attr(all(not(target_arch = "wasm32"), feature = "specta"), derive(specta::Type))]
#[tsify(into_wasm_abi, from_wasm_abi)]
#[serde(rename_all = "lowercase")]
pub enum ModelProvider {
    /// HuggingFace model provider
    #[serde(rename = "huggingface")]
    HuggingFace,
    /// Civitai model provider
    #[serde(rename = "civitai")]
    Civitai,
    /// Local model provider
    #[serde(rename = "local")]
    Local,
}

impl ModelProvider {
    /// Get provider display name
    pub fn display_name(&self) -> &'static str {
        match self {
            ModelProvider::HuggingFace => "HuggingFace",
            ModelProvider::Civitai => "Civitai",
            ModelProvider::Local => "Local",
        }
    }

    /// Get provider slug for URLs
    pub fn slug(&self) -> &'static str {
        match self {
            ModelProvider::HuggingFace => "huggingface",
            ModelProvider::Civitai => "civitai",
            ModelProvider::Local => "local",
        }
    }

    /// Parse provider from slug
    pub fn from_slug(slug: &str) -> Option<Self> {
        match slug {
            "huggingface" => Some(ModelProvider::HuggingFace),
            "civitai" => Some(ModelProvider::Civitai),
            "local" => Some(ModelProvider::Local),
            _ => None,
        }
    }
}

/// Model category - WHAT the model does (orthogonal to provider)
#[derive(Debug, Clone, Serialize, Deserialize, Tsify, PartialEq, Eq)]
#[cfg_attr(all(not(target_arch = "wasm32"), feature = "specta"), derive(specta::Type))]
#[tsify(into_wasm_abi, from_wasm_abi)]
#[serde(rename_all = "lowercase")]
pub enum ModelCategory {
    /// Language models (text generation, chat, code)
    #[serde(rename = "llm")]
    Llm,
    /// Image generation models (Stable Diffusion, etc.)
    #[serde(rename = "image")]
    Image,
    /// Audio models
    #[serde(rename = "audio")]
    Audio,
    /// Video models
    #[serde(rename = "video")]
    Video,
    /// Other/unknown
    #[serde(rename = "other")]
    Other,
}

impl ModelCategory {
    /// Get category display name
    pub fn display_name(&self) -> &'static str {
        match self {
            ModelCategory::Llm => "Language Model",
            ModelCategory::Image => "Image Generation",
            ModelCategory::Audio => "Audio",
            ModelCategory::Video => "Video",
            ModelCategory::Other => "Other",
        }
    }

    /// Get category slug for URLs
    pub fn slug(&self) -> &'static str {
        match self {
            ModelCategory::Llm => "llm",
            ModelCategory::Image => "image",
            ModelCategory::Audio => "audio",
            ModelCategory::Video => "video",
            ModelCategory::Other => "other",
        }
    }
}


/// Worker binary info for marketplace display
/// TEAM-404: Uses canonical WorkerType from artifacts-contract
#[derive(Debug, Clone, Serialize, Deserialize, Tsify)]
#[tsify(into_wasm_abi, from_wasm_abi)]
#[serde(rename_all = "camelCase")]
pub struct Worker {
    /// Unique worker identifier
    pub id: String,
    /// Worker name
    pub name: String,
    /// Worker description
    pub description: String,
    /// Worker version (semver)
    pub version: String,
    /// Supported platforms (linux, macos, windows)
    pub platform: Vec<String>,
    /// Supported architectures (x86_64, aarch64)
    pub architecture: Vec<String>,
    /// Worker type (cpu, cuda, metal)
    pub worker_type: WorkerType,
}

// TEAM-404: WorkerType is now re-exported from artifacts-contract (see top of file)
// No need to redefine it here - single source of truth!

/// Model filters
#[derive(Debug, Clone, Serialize, Deserialize, Tsify)]
#[tsify(into_wasm_abi, from_wasm_abi)]
pub struct ModelFilters {
    /// Search query string
    #[serde(skip_serializing_if = "Option::is_none")]
    pub search: Option<String>,
    /// Category filter
    #[serde(skip_serializing_if = "Option::is_none")]
    pub category: Option<String>,
    /// Sort order
    #[serde(skip_serializing_if = "Option::is_none")]
    pub sort: Option<SortOrder>,
    /// Maximum number of results
    #[serde(skip_serializing_if = "Option::is_none")]
    pub limit: Option<u32>,
}

/// Sort order
#[derive(Debug, Clone, Serialize, Deserialize, Tsify)]
#[tsify(into_wasm_abi, from_wasm_abi)]
pub enum SortOrder {
    /// Sort by popularity (downloads, likes)
    Popular,
    /// Sort by most recent
    Recent,
    /// Sort by trending (recent popularity spike)
    Trending,
}
