name: Build macOS

on:
  push:
    branches:
      - production
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-macos:
    name: Build macOS Binaries
    runs-on: self-hosted
    # This will run on your mac.home.arpa machine
    # You need to set up a self-hosted runner with label: macos
    if: contains(github.event.head_commit.message, '[build-mac]') || github.ref_type == 'tag'
    
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          
      - name: Install Rust
        run: |
          if ! command -v rustc &> /dev/null; then
            curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
            source $HOME/.cargo/env
          fi
          rustup update stable
          
      - name: Build release binaries
        run: |
          cargo build --release --bin rbee-keeper
          cargo build --release --bin queen-rbee
          cargo build --release --bin rbee-hive
          
      - name: Create macOS package
        run: |
          mkdir -p dist/macos
          cp target/release/rbee-keeper dist/macos/
          cp target/release/queen-rbee dist/macos/
          cp target/release/rbee-hive dist/macos/
          
          # Create install script for macOS
          cat > dist/macos/install.sh << 'EOF'
          #!/bin/bash
          # rbee installer for macOS
          set -e
          
          INSTALL_DIR="${INSTALL_DIR:-/usr/local/bin}"
          
          echo "Installing rbee to $INSTALL_DIR..."
          
          sudo cp rbee-keeper "$INSTALL_DIR/"
          sudo cp queen-rbee "$INSTALL_DIR/"
          sudo cp rbee-hive "$INSTALL_DIR/"
          
          sudo chmod +x "$INSTALL_DIR/rbee-keeper"
          sudo chmod +x "$INSTALL_DIR/queen-rbee"
          sudo chmod +x "$INSTALL_DIR/rbee-hive"
          
          echo "âœ… rbee installed successfully!"
          echo "Run: rbee-keeper --help"
          EOF
          chmod +x dist/macos/install.sh
          
          # Create tarball
          cd dist/macos
          tar -czf ../rbee-macos-$(uname -m).tar.gz *
          
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-binaries
          path: dist/rbee-macos-*.tar.gz
          
      - name: Upload to release (if tag)
        if: github.ref_type == 'tag'
        uses: softprops/action-gh-release@v1
        with:
          files: dist/rbee-macos-*.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
