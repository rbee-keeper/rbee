name: Production Release

on:
  push:
    branches:
      - production
  pull_request:
    branches:
      - production

env:
  CARGO_TERM_COLOR: always

jobs:
  # Required status check: build
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        
      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          
      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}
          
      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}
          
      - name: Build all targets
        run: cargo build --all-targets --release

  # Required status check: test
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        
      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-test-${{ hashFiles('**/Cargo.lock') }}
          
      - name: Run tests
        run: cargo test --all --release

  # Required status check: clippy
  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
          
      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-clippy-${{ hashFiles('**/Cargo.lock') }}
          
      - name: Run clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

  # Frontend build (optional but recommended)
  frontend-build:
    name: Frontend Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm
          
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        
      - name: Build frontend
        run: pnpm run build

  # Build artifacts for different platforms
  build-linux:
    name: Build Linux Artifacts
    runs-on: ubuntu-latest
    needs: [build, test, clippy]
    if: github.event_name == 'push' && github.ref == 'refs/heads/production'
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        
      - name: Build release binaries
        run: |
          cargo build --release --bin rbee-keeper
          cargo build --release --bin queen-rbee
          cargo build --release --bin rbee-hive
          
      - name: Create install script
        run: |
          cat > install.sh << 'EOF'
          #!/bin/bash
          # rbee installer for Linux
          # Usage: curl -fsSL https://install.rbee.dev | sh
          
          set -e
          
          VERSION="${VERSION:-latest}"
          INSTALL_DIR="${INSTALL_DIR:-$HOME/.local/bin}"
          
          echo "Installing rbee $VERSION to $INSTALL_DIR..."
          
          # Download and install binaries
          # TODO: Implement download from GitHub releases
          
          echo "✅ rbee installed successfully!"
          EOF
          chmod +x install.sh
          
      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-binaries
          path: |
            target/release/rbee-keeper
            target/release/queen-rbee
            target/release/rbee-hive
            install.sh

  # Create GitHub Release (only on push to production)
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build, test, clippy, frontend-build, build-linux]
    if: github.event_name == 'push' && github.ref == 'refs/heads/production'
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Get version from Cargo.toml
        id: version
        run: |
          VERSION=$(grep '^version = ' Cargo.toml | head -1 | cut -d'"' -f2)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION" >> $GITHUB_OUTPUT
          
      - name: Check if tag exists
        id: check_tag
        run: |
          if git rev-parse "v${{ steps.version.outputs.version }}" >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
          
      - name: Download Linux artifacts
        uses: actions/download-artifact@v4
        with:
          name: linux-binaries
          path: ./artifacts/linux
          
      - name: Generate changelog
        id: changelog
        run: |
          # Get commits since last tag
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -z "$LAST_TAG" ]; then
            COMMITS=$(git log --pretty=format:"- %s (%h)" --reverse)
          else
            COMMITS=$(git log ${LAST_TAG}..HEAD --pretty=format:"- %s (%h)" --reverse)
          fi
          
          # Save to file for multiline output
          echo "$COMMITS" > changelog.txt
          
      - name: Create Release
        if: steps.check_tag.outputs.exists == 'false'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: Release ${{ steps.version.outputs.version }}
          body_path: changelog.txt
          draft: false
          prerelease: false
          files: |
            artifacts/linux/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Release already exists
        if: steps.check_tag.outputs.exists == 'true'
        run: |
          echo "⚠️  Release ${{ steps.version.outputs.tag }} already exists"
          echo "Bump version in Cargo.toml to create a new release"
