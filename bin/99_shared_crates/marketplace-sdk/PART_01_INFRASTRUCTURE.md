# Part 1: Core Infrastructure Setup

**Status:** Phase 1 Complete (Types) | Phase 1.5 In Progress  
**Estimated Time:** 2-3 days  
**Prerequisites:** Rust, wasm-pack, Node.js/pnpm

---

## Overview

This part covers the foundational infrastructure for the marketplace SDK, including build tooling, WASM compilation, NPM packaging, and CI/CD setup.

---

## ‚úÖ Phase 1: Types & Project Setup (COMPLETE)

### What Was Done (TEAM-402)

1. **Cargo.toml Configuration**
   - WASM dependencies (`wasm-bindgen`, `wasm-bindgen-futures`)
   - Serialization (`serde`, `serde-wasm-bindgen`, `serde_json`)
   - TypeScript generation (`tsify`)
   - HTTP client (`reqwest` with WASM features)
   - Async runtime (`tokio` with WASM-compatible features)

2. **Type Definitions**
   - `Model` - Marketplace model display type
   - `Worker` - Worker binary display type
   - `ModelSource` - HuggingFace vs CivitAI
   - `WorkerType` - CPU/CUDA/Metal
   - `ModelFilters` - Search/filter criteria
   - `WorkerFilters` - Worker search criteria

3. **artifacts-contract Integration**
   - Re-exports `CatalogModelEntry` and `CatalogWorkerBinary`
   - Enables conversion between catalog types and display types

4. **WASM Module Initialization**
   - `init()` function with console logging
   - Entry point for WASM module

---

## üöß Phase 1.5: Build & Tooling

### Required Reading

#### WASM Fundamentals
- **[Rust and WebAssembly Book](https://rustwasm.github.io/docs/book/)** (Chapters 1-4)
  - Understanding WASM compilation
  - Memory model
  - JavaScript interop
  - Performance considerations

#### wasm-pack Documentation
- **[wasm-pack Book](https://rustwasm.github.io/docs/wasm-pack/)** (Full read)
  - Build targets (bundler, web, nodejs)
  - Package.json generation
  - NPM publishing workflow
  - Optimization flags

#### wasm-bindgen Guide
- **[wasm-bindgen Guide](https://rustwasm.github.io/docs/wasm-bindgen/)** (Chapters 1-6)
  - Type conversions (Rust ‚Üî JavaScript)
  - Importing JavaScript functions
  - Exporting Rust functions
  - Working with JS objects
  - Closures and callbacks

#### TypeScript Integration
- **[tsify Documentation](https://docs.rs/tsify/latest/tsify/)** (Full read)
  - Deriving TypeScript types from Rust
  - Handling enums and structs
  - Generic types
  - Optional fields

---

### Tasks

#### 1. Create Build Script (`build-wasm.sh`)

**Purpose:** Automate WASM compilation for different targets

**Script Requirements:**
```bash
#!/bin/bash
# TEAM-XXX: Marketplace SDK WASM build script

set -e  # Exit on error

echo "üõí Building marketplace-sdk WASM..."

# Clean previous builds
rm -rf pkg/

# Build for bundler (Webpack, Vite, Rollup)
echo "üì¶ Building for bundler..."
wasm-pack build --target bundler --out-dir pkg/bundler

# Build for web (direct browser import)
echo "üåê Building for web..."
wasm-pack build --target web --out-dir pkg/web

# Build for Node.js
echo "üü¢ Building for nodejs..."
wasm-pack build --target nodejs --out-dir pkg/nodejs

# Generate TypeScript types
echo "üìù Generating TypeScript types..."
# Types are auto-generated by wasm-pack

echo "‚úÖ Build complete!"
echo "üì¶ Bundler: pkg/bundler/"
echo "üåê Web: pkg/web/"
echo "üü¢ Node.js: pkg/nodejs/"
```

**Verification:**
- [ ] Script is executable (`chmod +x build-wasm.sh`)
- [ ] All three targets build successfully
- [ ] `.d.ts` files generated in each target
- [ ] `package.json` generated in each target

---

#### 2. Configure `Cargo.toml` Metadata

**Purpose:** Provide metadata for wasm-pack NPM package generation

**Add to `Cargo.toml`:**
```toml
[package.metadata.wasm-pack.profile.release]
# Optimize for size (WASM bundles should be small)
wasm-opt = ["-Oz", "--enable-mutable-globals"]

[package.metadata.wasm-pack.profile.dev]
# Faster builds for development
wasm-opt = false
```

**Update package metadata:**
```toml
[package]
name = "marketplace-sdk"
version = "0.1.0"
edition = "2021"
authors = ["rbee Team"]
license = "GPL-3.0-or-later"
description = "Rust SDK for marketplace (HuggingFace, CivitAI, Worker Catalog) that compiles to WASM"
repository = "https://github.com/veighnsche/rbee"
keywords = ["rbee", "marketplace", "huggingface", "civitai", "wasm"]
categories = ["wasm", "api-bindings"]
readme = "README.md"
```

**Verification:**
- [ ] Metadata appears in generated `package.json`
- [ ] Release builds are optimized for size
- [ ] Dev builds compile quickly

---

#### 3. Create NPM Package Configuration

**Purpose:** Configure NPM package for publishing

**Create `package.json.template`:**
```json
{
  "name": "@rbee/marketplace-sdk",
  "version": "0.1.0",
  "description": "Rust SDK for marketplace (HuggingFace, CivitAI, Worker Catalog) compiled to WASM",
  "main": "bundler/marketplace_sdk.js",
  "types": "bundler/marketplace_sdk.d.ts",
  "files": [
    "bundler/",
    "web/",
    "nodejs/",
    "README.md",
    "LICENSE"
  ],
  "exports": {
    ".": {
      "types": "./bundler/marketplace_sdk.d.ts",
      "import": "./bundler/marketplace_sdk.js",
      "require": "./bundler/marketplace_sdk.js"
    },
    "./web": {
      "types": "./web/marketplace_sdk.d.ts",
      "import": "./web/marketplace_sdk.js"
    },
    "./nodejs": {
      "types": "./nodejs/marketplace_sdk.d.ts",
      "import": "./nodejs/marketplace_sdk.js",
      "require": "./nodejs/marketplace_sdk.js"
    }
  },
  "repository": {
    "type": "git",
    "url": "https://github.com/veighnsche/rbee.git",
    "directory": "bin/99_shared_crates/marketplace-sdk"
  },
  "keywords": [
    "wasm",
    "marketplace",
    "huggingface",
    "civitai",
    "llm",
    "models",
    "workers"
  ],
  "author": "rbee Team",
  "license": "GPL-3.0-or-later",
  "sideEffects": [
    "./bundler/marketplace_sdk_bg.wasm",
    "./web/marketplace_sdk_bg.wasm",
    "./nodejs/marketplace_sdk_bg.wasm"
  ]
}
```

**Verification:**
- [ ] Package name follows NPM conventions
- [ ] All exports are valid
- [ ] Types are correctly referenced
- [ ] WASM files marked as side effects

---

#### 4. Create `.npmignore`

**Purpose:** Exclude unnecessary files from NPM package

**Create `.npmignore`:**
```
# Source files
src/
target/
Cargo.toml
Cargo.lock
build-wasm.sh

# Documentation (except README)
docs/
*.md
!README.md

# Development files
.git/
.github/
.vscode/
.idea/

# Test files
tests/
benches/

# CI files
.gitlab-ci.yml
.travis.yml
```

**Verification:**
- [ ] Only necessary files included in package
- [ ] Package size is reasonable (<5MB)

---

#### 5. Add CI/CD Workflow

**Purpose:** Automate builds and tests on every commit

**Create `.github/workflows/marketplace-sdk.yml`:**
```yaml
name: Marketplace SDK

on:
  push:
    paths:
      - 'bin/99_shared_crates/marketplace-sdk/**'
      - '.github/workflows/marketplace-sdk.yml'
  pull_request:
    paths:
      - 'bin/99_shared_crates/marketplace-sdk/**'

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown
      
      - name: Install wasm-pack
        run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh
      
      - name: Run tests
        run: |
          cd bin/99_shared_crates/marketplace-sdk
          cargo test
          wasm-pack test --headless --firefox
          wasm-pack test --headless --chrome

  build:
    name: Build WASM
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown
      
      - name: Install wasm-pack
        run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh
      
      - name: Build WASM
        run: |
          cd bin/99_shared_crates/marketplace-sdk
          ./build-wasm.sh
      
      - name: Check bundle size
        run: |
          cd bin/99_shared_crates/marketplace-sdk
          ls -lh pkg/bundler/*.wasm
          # Fail if bundle is too large (>2MB)
          size=$(stat -c%s pkg/bundler/marketplace_sdk_bg.wasm)
          if [ $size -gt 2097152 ]; then
            echo "‚ùå WASM bundle too large: $size bytes (max 2MB)"
            exit 1
          fi
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: wasm-packages
          path: bin/99_shared_crates/marketplace-sdk/pkg/

  publish:
    name: Publish to NPM
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/marketplace-sdk-v')
    steps:
      - uses: actions/checkout@v4
      
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: wasm-packages
          path: bin/99_shared_crates/marketplace-sdk/pkg/
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          registry-url: 'https://registry.npmjs.org'
      
      - name: Publish to NPM
        run: |
          cd bin/99_shared_crates/marketplace-sdk/pkg/bundler
          npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
```

**Verification:**
- [ ] CI runs on every push
- [ ] Tests pass in Firefox and Chrome
- [ ] WASM builds successfully
- [ ] Bundle size is checked
- [ ] Artifacts are uploaded

---

#### 6. Update README.md

**Purpose:** Document build and usage instructions

**Add to README.md:**
```markdown
## Building from Source

### Prerequisites

- Rust 1.70+ with `wasm32-unknown-unknown` target
- wasm-pack (`cargo install wasm-pack`)
- Node.js 18+ (for testing)

### Build WASM

```bash
# Build all targets
./build-wasm.sh

# Or build specific target
wasm-pack build --target bundler
wasm-pack build --target web
wasm-pack build --target nodejs
```

### Run Tests

```bash
# Rust tests
cargo test

# WASM tests (browser)
wasm-pack test --headless --firefox
wasm-pack test --headless --chrome

# WASM tests (Node.js)
wasm-pack test --node
```

### Bundle Size

Current bundle sizes (gzipped):
- Bundler: ~XXX KB
- Web: ~XXX KB
- Node.js: ~XXX KB

### Optimization

The release build uses:
- `wasm-opt -Oz` for maximum size reduction
- `--enable-mutable-globals` for better performance
- Link-time optimization (LTO)
- Code size optimization in Cargo.toml
```

**Verification:**
- [ ] Instructions are clear and complete
- [ ] All commands work as documented
- [ ] Bundle sizes are documented

---

## Acceptance Criteria

### Build System
- [ ] `build-wasm.sh` script exists and is executable
- [ ] All three targets (bundler, web, nodejs) build successfully
- [ ] Build completes in <2 minutes
- [ ] No warnings or errors during build

### Package Configuration
- [ ] `package.json` metadata is correct
- [ ] `.npmignore` excludes unnecessary files
- [ ] Package size is <5MB
- [ ] All exports work correctly

### CI/CD
- [ ] GitHub Actions workflow exists
- [ ] Tests run automatically on push
- [ ] WASM builds in CI
- [ ] Bundle size is checked
- [ ] Artifacts are uploaded

### Documentation
- [ ] README has build instructions
- [ ] README has test instructions
- [ ] README has optimization notes
- [ ] All commands are tested and work

### Quality
- [ ] No `TODO` markers in code
- [ ] All files have TEAM-XXX signatures
- [ ] Code follows Rust conventions
- [ ] WASM bundle is optimized

---

## Common Issues & Solutions

### Issue: `wasm-pack` not found
**Solution:** Install with `cargo install wasm-pack`

### Issue: Build fails with "target not found"
**Solution:** Add target with `rustup target add wasm32-unknown-unknown`

### Issue: Bundle size too large
**Solution:** 
- Enable LTO in Cargo.toml
- Use `wasm-opt -Oz`
- Remove unused dependencies
- Check for duplicate dependencies

### Issue: TypeScript types not generated
**Solution:**
- Ensure `tsify` is in dependencies
- Add `#[derive(Tsify)]` to types
- Check `wasm-pack` output for errors

### Issue: WASM tests fail in browser
**Solution:**
- Install browser drivers (geckodriver, chromedriver)
- Check console for JavaScript errors
- Verify WASM module loads correctly

---

## Next Steps

After completing Part 1, proceed to:
- **Part 2:** HuggingFace Client Implementation
- Verify WASM builds work in browser
- Test TypeScript types in a simple HTML page
- Measure baseline bundle size

---

## References

- [Rust and WebAssembly Book](https://rustwasm.github.io/docs/book/)
- [wasm-pack Documentation](https://rustwasm.github.io/docs/wasm-pack/)
- [wasm-bindgen Guide](https://rustwasm.github.io/docs/wasm-bindgen/)
- [tsify Documentation](https://docs.rs/tsify/latest/tsify/)
- [NPM Package Best Practices](https://docs.npmjs.com/packages-and-modules/contributing-packages-to-the-registry)
